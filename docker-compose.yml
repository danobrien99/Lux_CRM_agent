services:
  api:
    image: python:3.11-slim
    working_dir: /workspace/apps/api
    command: bash -lc "pip install -e . && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    env_file:
      - .env
    environment:
      NEO4J_URI: ${NEO4J_URI:-neo4j://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-changeme}
    volumes:
      - .:/workspace
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - neo4j

  worker:
    image: python:3.11-slim
    working_dir: /workspace/apps/api
    command: bash -lc "pip install -e . && rq worker --url ${REDIS_URL:-redis://redis:6379/0}"
    env_file:
      - .env
    environment:
      NEO4J_URI: ${NEO4J_URI:-neo4j://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-changeme}
    volumes:
      - .:/workspace
    depends_on:
      - redis
      - neo4j

  neo4j:
    image: neo4j:5.26-community
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-changeme}
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  n8n:
    image: n8nio/n8n:latest
    env_file:
      - .env
    environment:
      N8N_BLOCK_ENV_ACCESS_IN_NODE: "false"
    ports:
      - "$N8N_PORT:5680"
    volumes:
      - ./n8n:/home/node/.n8n

  ui:
    image: node:20-alpine
    working_dir: /workspace/apps/ui
    command: sh -lc "rm -rf .next && npm install && npm run dev"
    env_file:
      - .env
    volumes:
      - .:/workspace
    ports:
      - "3000:3000"
    depends_on:
      - api

volumes:
  neo4j_data:
    name: lux_crm_agent_neo4j_data_isolated
  neo4j_logs:
    name: lux_crm_agent_neo4j_logs_isolated
